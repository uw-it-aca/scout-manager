sudo: false
language: python
python:
  - "3.6"
services:
  - docker
os:
  - linux
env:
  global:
    - RELEASE_NAME="scout_manager"
    - DJANGO_APP="scout_manager"
    - COMMIT_HASH="$(git rev-parse --short=7 HEAD)"
    - IMAGE_TAG="${RELEASE_NAME}:${COMMIT_HASH}"
install:
  - docker build --target app-container -t "${IMAGE_TAG}" .
  - docker build -t "${IMAGE_TAG}-test" .
before_script:
  # - pip install -U 'setuptools>=18.5'
  - pip install coverage
  - pip install coveralls
  - npm install mocha
  - npm install jquery
  - npm install jsdom
script:
  - docker run -u root -it -v /tmp:/coverage -e DJANGO_APP="${DJANGO_APP}" -e "ENV=localdev"  "${IMAGE_TAG}-test" bash -c ". ./travis/test.sh"
after_script:
  - cp /tmp/.coverage.* .
  - coverage combine
  - coveralls
  # - |
  #   if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
  #     case "$TRAVIS_BRANCH" in
  #       "master")
  #         export APP_INSTANCE="prod";
  #         ;;
  #       "qa")
  #         export APP_INSTANCE="test";
  #         ;;
  #       "develop")
  #         export APP_INSTANCE="dev";
  #         ;;
  #       *)
  #         unset APP_INSTANCE
  #         ;;
  #     esac
  #     if [[ "$APP_INSTANCE" ]]; then
  #       curl -Ls ${DEPLOY_SCRIPT_BASE}/travis-ci/deploy.sh | bash;
  #     fi
  #   fi
  # cache:
  #   directories:
  #   - "$HOME/helm"
  #   - "$HOME/kubeval"
notifications:
  slack:
    rooms:
      secure: jQuVU2IqZzUqjlYtRLcNmZ1vj64jwunhxG8s+Qko8g/Qtek66uyOg/Rz5U6kCGCAteuTF7sm598CKMzxNBcOUrM/96QBLF9Om8z6NAWjHeE7Iu/AINhYpZEr64cXEihyC3Z8VggwV53FUXSsWbHvAjX01aI67ul9zdC+0vNSM1hO93hZ9e+aHZOFKc+sxuUBKxG0J3uMZ/G8qwXVlQYa/TJslrJLlmF3kAxPkJzsdJ6bpMvVVbHBuYZQRT1oOfFFRoY0gbJNoLZr5oCG/jwm1BSx4x6H7lh0oTdXdUJVzWIk8t8QfFhWl0kCN3PK3lYxGQVoZJlfCNAR5Hb3xnl78RbAPyvSf+jV/2jn8vpOzxDc2p4XLCGe6AFaM21IOHrb69NYJ/ve8AMHrbHN+pGMtIZ2pyH5ezpiBBFK8Y7F2tbQpe5IEQeKcL9DGv4gkiuSaOlu7bY2I2A/5vjtcwoZ3vsFoF5REOEcCqr573a+/21zkdrxrGa/S7ZXIQfXSP46Rxqn4DiQfKcvFJXgb7KuyTj23pUsSDtTYevhVy4BniWyFxJreda/Z1DIi54xlMSQMvHAoRtlbfqwac8sHhjXwnUdv208OLCtCwRsRLbZziXvRF399U3C3zGh9Wo+oPhxdpciQeLLJCaaGRq/hNThFp+OmMdXa/MFIYnV7FYpmtQ=
    on_failure: always
    on_success: change
